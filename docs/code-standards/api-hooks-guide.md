# API Hooks Generation Guide

This guide explains how to generate React Query hooks for both OnlineMenuSaaS and IdentityService APIs.

## ðŸŽ¯ Overview

The app now uses **two separate microservices**:
- **OnlineMenuSaaS** (Port 5006) - Business logic (menus, questionnaires)
- **IdentityService** (Port 5002) - Authentication, users, tenants

API hooks are auto-generated using [Orval](https://orval.dev/) from OpenAPI/Swagger specs.

## ðŸš€ Quick Start

### 1. Start Both Services

```powershell
# Option A: Use the unified startup script (easiest)
cd C:\desktopContents\projects\OnlineMenuSaaS
.\Start-AllServices.ps1 -Docker

# Option B: Start individually
cd C:\desktopContents\projects\IdentityService
docker-compose up -d

cd C:\desktopContents\projects\OnlineMenuSaaS
docker-compose up -d
```

### 2. Generate Hooks

```powershell
cd clients\OnlineMenuClientApp

# Generate hooks from running services
npm run generate:hooks

# Or manually with custom URLs
powershell ./scripts/Generate-ApiHooks.ps1 -OnlineMenuUrl "https://localhost:5006" -IdentityUrl "http://localhost:5002"
```

### 3. Use the Hooks

```typescript
// Import hooks from the appropriate service
import { useListTenantMenus } from '@/server/autoGeneratedHooks/onlinemenu';
import { useLogin, useListUsers } from '@/server/autoGeneratedHooks/identity';

function MyComponent() {
  // OnlineMenuSaaS API
  const { data: menus } = useListTenantMenus();

  // IdentityService API
  const { mutate: login } = useLogin();
  const { data: users } = useListUsers();

  return (
    // Your component code
  );
}
```

## ðŸ“ Generated Structure

After generation, you'll have:

```
src/server/
â”œâ”€â”€ autoGeneratedHooks/
â”‚   â”œâ”€â”€ onlinemenu/          # OnlineMenuSaaS hooks
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ models/          # TypeScript types
â”‚   â”‚   â”œâ”€â”€ tenantmenus/     # Menu-related hooks
â”‚   â”‚   â”œâ”€â”€ questionertemplates/
â”‚   â”‚   â””â”€â”€ completedquestioners/
â”‚   â””â”€â”€ identity/            # IdentityService hooks
â”‚       â”œâ”€â”€ index.ts
â”‚       â”œâ”€â”€ models/          # TypeScript types
â”‚       â”œâ”€â”€ auth/            # Authentication hooks
â”‚       â”œâ”€â”€ users/           # User management hooks
â”‚       â””â”€â”€ tenants/         # Tenant management hooks
â”œâ”€â”€ swagger/
â”‚   â”œâ”€â”€ onlinemenu.json      # Downloaded OpenAPI spec
â”‚   â””â”€â”€ identity.json        # Downloaded OpenAPI spec
â”œâ”€â”€ httpClient.ts            # OnlineMenuSaaS HTTP client
â””â”€â”€ httpClientIdentity.ts    # IdentityService HTTP client
```

## ðŸ”§ Configuration

### Orval Configuration ([orval.config.js](orval.config.js))

```javascript
module.exports = defineConfig({
  // OnlineMenuSaaS Business API
  onlineMenuApi: {
    input: {
      target: './src/server/swagger/onlinemenu.json',
    },
    output: {
      target: './src/server/autoGeneratedHooks/onlinemenu/index.ts',
      client: 'react-query',
      mode: 'tags-split',
      override: {
        mutator: {
          path: './src/server/httpClient.ts',
          name: 'customInstance',
        },
      },
    },
  },

  // IdentityService API
  identityApi: {
    input: {
      target: './src/server/swagger/identity.json',
    },
    output: {
      target: './src/server/autoGeneratedHooks/identity/index.ts',
      client: 'react-query',
      mode: 'tags-split',
      override: {
        mutator: {
          path: './src/server/httpClientIdentity.ts',
          name: 'identityInstance',
        },
      },
    },
  },
});
```

### HTTP Client Configuration

**For OnlineMenuSaaS** ([httpClient.ts](src/server/httpClient.ts)):
- Uses `API_URL` from environment (default: https://localhost:5006)
- Handles business logic APIs

**For IdentityService** ([httpClientIdentity.ts](src/server/httpClientIdentity.ts)):
- Uses `IDENTITY_API_URL` from environment (default: http://localhost:5002)
- Handles auth, users, tenants

## ðŸ“ NPM Scripts

```json
{
  "scripts": {
    "generate:hooks": "Download specs and generate hooks from both services",
    "generate:hooks:skip-download": "Generate using existing swagger files"
  }
}
```

## ðŸ› ï¸ Manual Generation Steps

If you prefer to generate manually:

### 1. Download Swagger Specs

```powershell
# OnlineMenuSaaS
Invoke-RestMethod -Uri "https://localhost:5006/swagger/v1/swagger.json" `
  -OutFile "src/server/swagger/onlinemenu.json" -SkipCertificateCheck

# IdentityService
Invoke-RestMethod -Uri "http://localhost:5002/swagger/v1/swagger.json" `
  -OutFile "src/server/swagger/identity.json"
```

### 2. Run Orval

```powershell
npx orval --config orval.config.js
```

## ðŸ” Troubleshooting

### "Failed to download spec"

**Problem:** Services not running or wrong URLs

**Solution:**
```powershell
# Check if services are running
docker ps

# Or start them
.\Start-AllServices.ps1 -Docker
```

### "Swagger endpoint not found" (IdentityService)

**Problem:** IdentityService Swagger not configured

**Solution:** Ensure IdentityService [Program.cs](../../../IdentityService/src/IdentityService.API/Program.cs) has:
```csharp
builder.Services.AddFastEndpoints()
    .SwaggerDocument(o => { ... });

app.UseSwaggerGen();
```

### "IDENTITY_API_URL not defined"

**Problem:** Environment config missing

**Solution:** Update [environment.ts](src/config/environment.ts):
```typescript
const ENV = {
  dev: {
    API_URL: 'https://localhost:5006',          // OnlineMenuSaaS
    IDENTITY_API_URL: 'http://localhost:5002',  // IdentityService (NEW)
    // ... other config
  }
};
```

### Hooks Not Found

**Problem:** Old import paths

**Solution:**
âŒ Old: `import { useLogin } from '@/server/autoGeneratedHooks/auth';`
âœ… New: `import { useLogin } from '@/server/autoGeneratedHooks/identity/auth';`

## ðŸ“š Migration from Old Structure

### Before (Monolithic)
All APIs in one place:
```typescript
import { useLogin } from '@/server/autoGeneratedHooks/auth';
import { useListUsers } from '@/server/autoGeneratedHooks/users';
import { useListTenantMenus } from '@/server/autoGeneratedHooks/tenantmenus';
```

### After (Microservices)
Separate by service:
```typescript
// Identity APIs
import { useLogin } from '@/server/autoGeneratedHooks/identity/auth';
import { useListUsers } from '@/server/autoGeneratedHooks/identity/users';
import { useListTenants } from '@/server/autoGeneratedHooks/identity/tenants';

// Business APIs
import { useListTenantMenus } from '@/server/autoGeneratedHooks/onlinemenu/tenantmenus';
import { useListQuestionerTemplate } from '@/server/autoGeneratedHooks/onlinemenu/questionertemplates';
```

## ðŸŽ“ Best Practices

### 1. Regenerate After API Changes
Whenever backend endpoints change:
```powershell
npm run generate:hooks
```

### 2. Use TypeScript Types
All generated hooks include TypeScript types:
```typescript
import type { TenantDto } from '@/server/autoGeneratedHooks/identity/models';

const tenant: TenantDto = {
  tenantId: '...',
  name: 'My Tenant',
  // TypeScript will enforce correct structure
};
```

### 3. Centralize API Calls
Create custom hooks that wrap generated ones:
```typescript
// hooks/useAuth.ts
import { useLogin as useLoginGenerated } from '@/server/autoGeneratedHooks/identity/auth';

export function useAuth() {
  const { mutate: login, ...rest } = useLoginGenerated();

  const handleLogin = (username: string, password: string) => {
    login({
      data: {
        method: 0,
        username,
        password,
      }
    });
  };

  return { handleLogin, ...rest };
}
```

### 4. Handle Base URLs Properly
Update `httpService.ts` to support multiple base URLs:
```typescript
const baseUrl = endpoint.startsWith('/api/auth') || endpoint.startsWith('/api/users')
  ? env.IDENTITY_API_URL
  : env.API_URL;
```

## ðŸ”— Related Documentation

- [Main README](../../README.md) - Full project setup
- [Migration Summary](../../MIGRATION_SUMMARY.md) - Architecture changes
- [Orval Documentation](https://orval.dev/)
- [React Query Documentation](https://tanstack.com/query/latest)

## ðŸ“ž Need Help?

1. Check service logs:
   ```powershell
   docker logs -f identityservice.api
   docker logs -f onlinemenu.web
   ```

2. Verify Swagger UI is accessible:
   - OnlineMenuSaaS: https://localhost:5006/swagger
   - IdentityService: http://localhost:5002/swagger

3. Review error messages in the generation script output

---

**Last Updated:** December 28, 2025
**Version:** 2.0.0 (Microservices)
