# Styling Architecture Guide

> **Complete reference** for understanding and customizing the theme system in SyncfusionThemeStudio.

This guide explains how styles are structured, the order they are applied, where to add customizations, and how to maintain performance while allowing full theme flexibility.

---

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [CSS Layers & Specificity](#css-layers--specificity)
3. [Theme Variable System](#theme-variable-system)
4. [Runtime Theme Injection](#runtime-theme-injection)
5. [Syncfusion Integration](#syncfusion-integration)
6. [Style Override Hierarchy](#style-override-hierarchy)
7. [Adding New Customizations](#adding-new-customizations)
8. [Performance Considerations](#performance-considerations)
9. [Troubleshooting](#troubleshooting)

---

## Architecture Overview

The styling system is built on three pillars:

```
┌─────────────────────────────────────────────────────────────────┐
│                    CSS LAYERS (Compile Time)                    │
│  base → components → syncfusion-overrides → utilities           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                CSS VARIABLES (Default Values)                   │
│  Defined in base.css, provide fallbacks before JS loads         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│               RUNTIME INJECTION (Theme Editor)                  │
│  themeInjector.ts updates CSS variables on document.documentElement │
└─────────────────────────────────────────────────────────────────┘
```

### Why This Architecture?

| Requirement | Solution |
|-------------|----------|
| Runtime theme editing | CSS variables injected via JavaScript |
| Performance | CSS layers prevent specificity wars, no inline styles |
| Syncfusion compatibility | Dedicated override layer with `!important` where needed |
| Light/Dark mode | Mode-specific variables + `.dark` class toggle |
| Component isolation | Each component type has its own variable namespace |

---

## CSS Layers & Specificity

CSS layers control the order styles are applied. Later layers win over earlier ones regardless of selector specificity.

### Layer Order

```css
@layer base, components, syncfusion-overrides, utilities;
```

| Layer | Purpose | Files |
|-------|---------|-------|
| `base` | CSS reset, theme variables, global styles | `base.css` |
| `components` | Application component styles (.btn, .card) | `components.css`, `components-critical.css` |
| `syncfusion-overrides` | Syncfusion component theming | `syncfusion-overrides.css`, `syncfusion-themed.css` |
| `utilities` | Tailwind utility classes | Generated by Tailwind |

### File Structure

```
src/styles/
├── login.css                    # Entry for login (minimal)
├── app.css                      # Entry for dashboard (full)
└── layers/
    ├── base.css                 # Theme tokens + reset
    ├── components.css           # All component styles
    ├── components-critical.css  # Login-only components
    ├── components-app.css       # Dashboard components
    ├── syncfusion-overrides.css # Syncfusion variable overrides
    └── syncfusion-themed.css    # Themed wrapper styles
```

### CSS Layer Benefits

```css
/* Without layers - specificity war */
.e-btn.e-primary { background: red; }           /* 0,2,0 */
.my-button.e-btn.e-primary { background: blue; } /* 0,3,0 - wins but ugly */

/* With layers - clean override */
@layer components {
  .my-button { background: red; }
}
@layer syncfusion-overrides {
  .e-btn.e-primary { background: blue; } /* Wins because later layer */
}
```

---

## Theme Variable System

All styling is driven by CSS custom properties (variables) for runtime customization.

### Variable Naming Convention

```
--[scope]-[category]-[property]
```

| Prefix | Scope | Example |
|--------|-------|---------|
| `--color-` | Global color palette | `--color-primary-500` |
| `--component-` | Component-specific | `--component-button-primary-bg` |
| `--radius-` | Border radius tokens | `--radius-md` |
| `--transition-` | Animation timing | `--transition-fast` |
| `--font-` | Typography | `--font-sans` |

### Color Variable Format

Colors use RGB triplet format (without `rgb()`) for Tailwind alpha compatibility:

```css
/* In CSS */
--color-primary-500: 59 130 246;

/* Usage with Tailwind */
bg-primary-500              → background: rgb(59 130 246);
bg-primary-500/50           → background: rgb(59 130 246 / 0.5);
```

### Component Variables

Each component type has its own namespace with full light/dark mode support:

```css
/* Button variables */
--component-button-primary-bg: rgb(59 130 246);
--component-button-primary-bg-hover: rgb(37 99 235);
--component-button-primary-text: rgb(255 255 255);

/* Input variables */
--component-input-background: rgb(255 255 255);
--component-input-border-default: rgb(209 213 219);
--component-input-border-focus: rgb(59 130 246);

/* DataGrid variables */
--component-datagrid-header-bg: rgb(249 250 251);
--component-datagrid-row-hover: rgb(243 244 246);
```

### Variable Hierarchy

```
Global Palette (primary, secondary, neutral)
    ↓
Status Colors (success, warning, error, info)
    ↓
Mode Colors (background, surface, text, border)
    ↓
Component Colors (button, input, sidebar, etc.)
```

---

## Runtime Theme Injection

The theme system injects CSS variables at runtime via JavaScript.

### Injection Flow

```
User changes color in theme editor
    ↓
Zustand store updates theme state
    ↓
injectThemeVariables() called
    ↓
Uses requestAnimationFrame for performance
    ↓
Sets CSS properties on document.documentElement
```

### Main Injector

**File:** `src/stores/theme/themeInjector.ts`

```typescript
export function injectThemeVariables(theme: ThemeConfig, mode: Mode): void {
  const root = document.documentElement;

  requestAnimationFrame(() => {
    // 1. Inject global color scales (primary, secondary, neutral)
    injectColorScale(root, 'primary', theme.primary);
    injectColorScale(root, 'secondary', theme.secondary);
    injectColorScale(root, 'neutral', theme.neutral);

    // 2. Inject status colors
    injectStatusColors(root, theme.status);

    // 3. Inject layout/typography tokens
    injectBorderRadius(root, theme.borderRadius);
    injectLayoutVariables(root, theme);

    // 4. Inject mode-specific surface colors
    const modeConfig = mode === 'dark' ? theme.dark : theme.light;
    injectModeColors(root, modeConfig);

    // 5. Inject component-specific colors (mode-aware)
    const componentConfig = mode === 'dark'
      ? theme.components.dark
      : theme.components.light;
    injectComponentVariables(root, componentConfig);

    // 6. Toggle dark mode class
    root.classList.toggle('dark', mode === 'dark');
  });
}
```

### Component Injector

**File:** `src/stores/theme/injectors/componentInjector.ts`

Each component type has a dedicated injector function:

```typescript
export function injectButtonVariables(root: HTMLElement, c: ComponentConfigSingle): void {
  root.style.setProperty('--component-button-primary-bg', `rgb(${c.buttons.primary.background})`);
  root.style.setProperty('--component-button-primary-bg-hover', `rgb(${c.buttons.primary.backgroundHover})`);
  root.style.setProperty('--component-button-primary-text', `rgb(${c.buttons.primary.textColor})`);
  // ... more button variables
}
```

### Value Format

**Store format:** Raw RGB triplets (`"59 130 246"`)
**Injected format:** Full CSS values (`"rgb(59 130 246)"`)

The injector wraps raw values with `rgb()` to create valid CSS:

```typescript
// Store value
theme.components.light.buttons.primary.background = "59 130 246";

// Injected as
--component-button-primary-bg: rgb(59 130 246);
```

---

## Syncfusion Integration

Syncfusion components require special handling because they ship with hardcoded styles.

### Override Strategy

```
Syncfusion base styles (from npm)
    ↓ Lower priority
syncfusion-overrides.css (our theming)
    ↓ Higher priority, uses CSS variables + !important
Component uses our theme colors
```

### Why `!important`?

Syncfusion components have high-specificity selectors with hardcoded colors. We use `!important` strategically to override them:

```css
/* Syncfusion's internal style */
.e-btn.e-primary {
  background-color: #0d6efd; /* Hardcoded */
}

/* Our override in syncfusion-overrides.css */
.e-btn.e-primary {
  background-color: var(--component-button-primary-bg) !important; /* Theme variable */
}
```

### Component Mapping

| Syncfusion Class | Our Variable |
|------------------|--------------|
| `.e-btn.e-primary` | `--component-button-primary-bg` |
| `.e-textbox` | `--component-input-*` |
| `.e-ddl` (dropdown) | `--component-select-*` |
| `.e-grid` | `--component-datagrid-*` |
| `.e-datepicker` | `--component-datepicker-*` |
| `.e-dialog` | `--component-dialog-*` |

### Themed Wrapper Classes

React wrappers add `sf-*` classes for additional styling hooks:

```tsx
// Button wrapper adds these classes
<button className={`sf-button sf-${mode} ${sizeClass}`}>
  {children}
</button>
```

---

## Style Override Hierarchy

Styles are applied in this order (later wins):

```
1. Syncfusion base CSS (from node_modules)
   ↓
2. base.css layer (CSS variables with fallback values)
   ↓
3. components.css layer (application styles)
   ↓
4. syncfusion-overrides.css layer (theme variable mappings)
   ↓
5. Runtime injection via themeInjector.ts (live updates)
   ↓
6. .dark class additions (dark mode overrides)
   ↓
7. Tailwind utilities (inline utility classes)
```

### Dark Mode Flow

```css
/* Default (light mode) defined in :root */
:root {
  --color-background: 255 255 255;
  --component-button-primary-bg: rgb(59 130 246);
}

/* Dark mode overrides via class */
.dark {
  --color-background: 17 24 39;
}

/* Component injector sets mode-specific values at runtime */
// JavaScript:
const config = mode === 'dark' ? theme.components.dark : theme.components.light;
injectComponentVariables(root, config);
```

---

## Adding New Customizations

### Adding a New Component Variable

**Step 1:** Add to type definitions

```typescript
// src/stores/theme/types/componentTypes.ts
interface NewComponentConfig {
  background: string;
  textColor: string;
  borderColor: string;
}

interface ComponentConfigSingle {
  // ... existing
  newComponent: NewComponentConfig;
}
```

**Step 2:** Add default values

```typescript
// src/stores/theme/defaults/componentDefaults.ts
export const DEFAULT_LIGHT_COMPONENTS: ComponentConfigSingle = {
  // ... existing
  newComponent: {
    background: '255 255 255',
    textColor: '17 24 39',
    borderColor: '229 231 235',
  },
};
```

**Step 3:** Create injector function

```typescript
// src/stores/theme/injectors/componentInjector.ts
export function injectNewComponentVariables(root: HTMLElement, c: ComponentConfigSingle): void {
  root.style.setProperty('--component-new-background', `rgb(${c.newComponent.background})`);
  root.style.setProperty('--component-new-text', `rgb(${c.newComponent.textColor})`);
  root.style.setProperty('--component-new-border', `rgb(${c.newComponent.borderColor})`);
}

// Add to main injector
export function injectComponentVariables(root: HTMLElement, components: ComponentConfigSingle): void {
  // ... existing calls
  injectNewComponentVariables(root, components);
}
```

**Step 4:** Add CSS fallbacks

```css
/* src/styles/layers/base.css */
:root {
  --component-new-background: rgb(255 255 255);
  --component-new-text: rgb(17 24 39);
  --component-new-border: rgb(229 231 235);
}

.dark {
  --component-new-background: rgb(31 41 55);
  --component-new-text: rgb(249 250 251);
  --component-new-border: rgb(75 85 99);
}
```

**Step 5:** Use in component

```css
/* src/styles/layers/components.css */
@layer components {
  .new-component {
    background-color: var(--component-new-background);
    color: var(--component-new-text);
    border: 1px solid var(--component-new-border);
  }
}
```

### Adding a Syncfusion Override

**File:** `src/styles/layers/syncfusion-overrides.css`

```css
@layer syncfusion-overrides {
  /* Target the Syncfusion component */
  .e-new-component {
    background-color: var(--component-new-background) !important;
    color: var(--component-new-text) !important;
    border-color: var(--component-new-border) !important;
  }

  /* State overrides */
  .e-new-component:hover:not(.e-disabled) {
    background-color: rgb(var(--color-primary-50)) !important;
  }

  .e-new-component:focus {
    box-shadow: 0 0 0 3px rgb(var(--color-primary-500) / 0.1) !important;
  }
}
```

### Modifying Existing Styles

1. **Never modify Syncfusion source files** - they'll be overwritten on update
2. **Add overrides in `syncfusion-overrides.css`** - ensures proper cascade
3. **Use CSS variables** - enables runtime customization
4. **Maintain light/dark parity** - add dark mode values when adding light mode

---

## Performance Considerations

### Batching Updates

The injector uses `requestAnimationFrame` to batch DOM updates:

```typescript
requestAnimationFrame(() => {
  // All CSS variable updates happen in one frame
  injectColorScale(root, 'primary', theme.primary);
  injectColorScale(root, 'secondary', theme.secondary);
  // ...
});
```

### CSS Code Splitting

```
login.css    → 6KB gzipped (login only)
app.css      → 140KB gzipped (loaded after login)
```

Login page loads minimal CSS. Full CSS loads when navigating to dashboard.

### Avoiding Paint Thrashing

**Do:**
```typescript
// Batch all reads, then all writes
const styles = getComputedStyle(element);
const currentColor = styles.getPropertyValue('--color-primary');

root.style.setProperty('--color-primary', newColor);
root.style.setProperty('--color-secondary', newSecondary);
```

**Don't:**
```typescript
// Interleaving reads/writes causes reflows
root.style.setProperty('--color-primary', newColor);
const styles = getComputedStyle(element); // Forces reflow
root.style.setProperty('--color-secondary', newSecondary);
```

### Variable Count Impact

| Variable Count | Performance Impact |
|----------------|-------------------|
| < 100 | Negligible |
| 100-500 | Minimal (current ~200) |
| > 1000 | Consider bundling |

Current implementation uses ~200 variables, well within safe limits.

### When to Use `!important`

| Scenario | Use `!important`? |
|----------|-------------------|
| Overriding Syncfusion hardcoded colors | Yes |
| Overriding our own base styles | No, use layers |
| Utility overrides | No, Tailwind handles this |
| Component variants | No, use CSS variables |

---

## Troubleshooting

### Variable Not Updating

**Symptom:** Theme editor changes don't apply to component

**Checklist:**
1. Is the variable being injected? Check DevTools > Elements > Styles
2. Is the CSS using the variable? Search for `var(--component-*)`
3. Is another rule overriding? Check computed styles priority
4. Is `!important` needed for Syncfusion?

### Dark Mode Not Working

**Symptom:** Component looks same in light/dark mode

**Checklist:**
1. Is `.dark` class on `<html>` element?
2. Are dark mode defaults defined in `base.css`?
3. Is component using mode-aware injector config?
4. Check: `theme.components.dark` vs `theme.components.light`

### Syncfusion Style Not Overridden

**Symptom:** Syncfusion component ignores our variables

**Fix:**
```css
/* Add !important and match Syncfusion selector specificity */
.e-btn.e-primary,
.e-css.e-btn.e-primary {
  background-color: var(--component-button-primary-bg) !important;
}
```

### Style Flashing on Load

**Symptom:** Default styles visible before theme applies

**Cause:** JavaScript hasn't loaded/executed yet

**Fix:** Ensure CSS fallbacks in `base.css` match your default theme:

```css
:root {
  /* These values should match DEFAULT_THEME */
  --component-button-primary-bg: rgb(59 130 246);
}
```

---

## Quick Reference

### Where to Add Styles

| Style Type | File Location |
|------------|---------------|
| Global CSS reset | `layers/base.css` |
| Theme variables | `layers/base.css` + injectors |
| Custom components | `layers/components.css` |
| Syncfusion overrides | `layers/syncfusion-overrides.css` |
| Themed wrapper styles | `layers/syncfusion-themed.css` |
| Tailwind utilities | Use classes directly |

### Variable Prefixes

| Prefix | Use For |
|--------|---------|
| `--color-primary-*` | Primary palette shades |
| `--color-secondary-*` | Secondary palette shades |
| `--color-neutral-*` | Gray scale |
| `--color-success/warning/error/info-*` | Status colors |
| `--component-*` | Component-specific styling |
| `--radius-*` | Border radius tokens |
| `--transition-*` | Animation timing |
| `--font-*` | Typography |

### Key Files

| File | Purpose |
|------|---------|
| `themeInjector.ts` | Orchestrates all CSS injection |
| `componentInjector.ts` | Component variable injection |
| `colorInjector.ts` | Color palette injection |
| `base.css` | CSS variable definitions |
| `syncfusion-overrides.css` | Syncfusion theming |

---

*Last Updated: 2026-02-10*
